<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AR VRM Model with Chat</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: Arial, sans-serif;
      }
      #messageBar {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        padding: 10px;
        box-sizing: border-box;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      #inputMessage {
        width: 80%;
        padding: 10px;
        border-radius: 4px;
        border: none;
      }
      #sendMessage {
        width: 18%;
        background-color: #007bff;
        color: white;
        padding: 10px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
      }
    </style>
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.169.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/",
          "@pixiv/three-vrm": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@3/lib/three-vrm.module.min.js"
        }
      }
    </script>
  </head>
  <body>
    <div id="messageBar">
      <input type="text" id="inputMessage" placeholder="Type your message..." />
      <button id="sendMessage">Send</button>
    </div>

    <script type="module">
      import * as THREE from 'three';
      import { ARButton } from 'three/addons/webxr/ARButton.js';
      import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
      import { VRMLoaderPlugin } from '@pixiv/three-vrm';

      let camera, scene, renderer, model, reticle;
      let vrmModel;

      const clock = new THREE.Clock();

      init();
      animate();

      function init() {
        // Setup the scene
        scene = new THREE.Scene();

        // Setup the camera
        camera = new THREE.PerspectiveCamera(
          70,
          window.innerWidth / window.innerHeight,
          0.1,
          20
        );

        // Setup renderer
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);

        // Add AR button
        document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] }));

        // Dynamic Lighting
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(1, 1, 1).normalize();
        scene.add(directionalLight);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);

        // Create a reticle for hit-test
        reticle = new THREE.Mesh(
          new THREE.RingGeometry(0.15, 0.2, 32),
          new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.6 })
        );
        reticle.matrixAutoUpdate = false;
        reticle.visible = false;
        scene.add(reticle);

        // Load VRM model
        const loader = new GLTFLoader();
        loader.register((parser) => new VRMLoaderPlugin(parser));

        loader.load('/models/VRM1_Constraint_Twist_Sample.vrm', (gltf) => {
          vrmModel = gltf.userData.vrm;
          scene.add(vrmModel.scene);
          vrmModel.scene.position.set(0, -1, -3); // Position on the ground initially
          vrmModel.scene.scale.set(1.0, 1.0, 1.0); // Adjust scale as necessary
          vrmModel.scene.rotation.y = Math.PI; // Make sure model faces the user
          // Enable blinking and idle animation if applicable
          vrmModel.humanoid.getBoneNode('neck').rotation.x = Math.PI / 10;
          console.log(vrmModel);
        });

        // XR hit-test setup
        const controller = renderer.xr.getController(0);
        controller.addEventListener('select', onSelect);
        scene.add(controller);

        window.addEventListener('resize', onWindowResize, false);
      }

      // Handle window resizing
      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      // Handle AR hit-test for reticle and model placement
      function onSelect() {
        if (reticle.visible && vrmModel) {
          vrmModel.scene.position.setFromMatrixPosition(reticle.matrix);
          vrmModel.scene.rotation.y = Math.PI; // Ensure model faces the user
        }
      }

      function animate() {
        renderer.setAnimationLoop(render);
      }

      function render() {
        // Rotate the model to face the camera
        if (vrmModel) {
          const direction = new THREE.Vector3();
          camera.getWorldDirection(direction);
          vrmModel.scene.lookAt(camera.position);
        }

        renderer.render(scene, camera);
      }
    </script>
  </body>
</html>
